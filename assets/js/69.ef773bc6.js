(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{406:function(e,s,n){"use strict";n.r(s);var a=n(25),r=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[e._v("#")]),e._v(" Nginx")]),e._v(" "),s("h2",{attrs:{id:"负载均衡-权重-ip-hash"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡-权重-ip-hash"}},[e._v("#")]),e._v(" 负载均衡，权重，ip_hash")]),e._v(" "),s("h3",{attrs:{id:"新建一个proxy-conf文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新建一个proxy-conf文件"}},[e._v("#")]),e._v(" 新建一个proxy.conf文件")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("proxy_redirect off;\nproxy_set_header Host $host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nclient_body_buffer_size 90;\nproxy_connect_timeout 90;\nproxy_read_timeout 90;\nproxy_buffer_size 4k;\nproxy_buffers 4 32k;\nproxy_busy_buffers_size 64k;\nproxy_temp_file_write_size 64k;\n")])])]),s("h3",{attrs:{id:"两种负载均衡方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#两种负载均衡方式"}},[e._v("#")]),e._v(" 两种负载均衡方式")]),e._v(" "),s("blockquote",[s("p",[e._v("这个配置文件,我们可以写到nginx.conf里面(如果只有一个web集群)，"),s("br"),e._v("\n如果有多个web集群,最好写到vhosts里面,以虚拟主机的方式,这里我写到nginx.conf里面")])]),e._v(" "),s("ul",[s("li",[e._v("轮询加权"),s("br"),e._v("\n(也可以不加权,就是1:1负载)")])]),e._v(" "),s("div",{staticClass:"language-config extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("    upstream lb {\n            server 192.168.196.130 weight=1 fail_timeout=20s;\n            server 192.168.196.132 weight=2 fail_timeout=20s;\n    }\n    \n    server {\n            listen 80;\n            server_name safexjt.com www.safexjt.com;\n            index index.html index.htm index.php;\n            location / {\n            \n                proxy_pass http://lb;\n                proxy_next_upstream http_500 http_502 http_503 error timeout invalid_header;\n                include proxy.conf;\n            }\n    }\n")])])]),s("ul",[s("li",[e._v("ip_hash"),s("br"),e._v("\n(同一ip会被分配给固定的后端服务器,解决session问题)")])]),e._v(" "),s("div",{staticClass:"language-config extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("    upstream lb {\n    \n        server 192.168.196.130 fail_timeout=20s;\n        server 192.168.196.132 fail_timeout=20s;\n        ip_hash;\n    }\n    \n    server {\n        listen 80;\n        server_name safexjt.com www.safexjt.com;\n        index index.html index.htm index.php;\n        location / {\n            proxy_pass http://lb;\n            proxy_next_upstream http_500 http_502 http_503 error timeout invalid_header;\n            include proxy.conf;\n        }\n    }\n")])])]),s("h3",{attrs:{id:"示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[e._v("#")]),e._v(" 示例")]),e._v(" "),s("h4",{attrs:{id:"轮询-默认"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#轮询-默认"}},[e._v("#")]),e._v(" 轮询（默认）")]),e._v(" "),s("p",[e._v("每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("upstream backserver {\n    server 192.168.0.14;\n    server 192.168.0.15;\n}\n")])])]),s("h4",{attrs:{id:"指定权重"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#指定权重"}},[e._v("#")]),e._v(" 指定权重")]),e._v(" "),s("p",[e._v("指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("upstream backserver {\n    server 192.168.0.14 weight=10;\n    server 192.168.0.15 weight=10;\n}\n")])])]),s("h4",{attrs:{id:"ip绑定-ip-hash"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ip绑定-ip-hash"}},[e._v("#")]),e._v(" IP绑定 ip_hash")]),e._v(" "),s("p",[e._v("每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("upstream backserver {\n    ip_hash;\n    server 192.168.0.14:88;\n    server 192.168.0.15:80;\n}\n")])])]),s("h4",{attrs:{id:"fair-第三方"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fair-第三方"}},[e._v("#")]),e._v(" fair（第三方）")]),e._v(" "),s("p",[e._v("按后端服务器的响应时间来分配请求，响应时间短的优先分配。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("upstream backserver {\n    server server1;\n    server server2;\n    fair;\n}\n")])])]),s("h4",{attrs:{id:"url-hash-第三方"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#url-hash-第三方"}},[e._v("#")]),e._v(" url_hash（第三方）")]),e._v(" "),s("p",[e._v("按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("upstream backserver {\n    server squid1:3128;\n    server squid2:3128;\n    hash $request_uri;\n    hash_method crc32;\n}\n")])])]),s("p",[e._v("在需要使用负载均衡的server中增加")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("proxy_pass http://backserver/;\nupstream backserver{\n    ip_hash;\n    server 127.0.0.1:9090 down; (down 表示单前的server暂时不参与负载)\n    server 127.0.0.1:8080 weight=2; (weight 默认为1.weight越大，负载的权重就越大)\n    server 127.0.0.1:6060;\n    server 127.0.0.1:7070 backup; (其它所有的非backup机器down或者忙的时候，请求backup机器)\n}\n")])])]),s("h4",{attrs:{id:"tcp转发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tcp转发"}},[e._v("#")]),e._v(" TCP转发")]),e._v(" "),s("blockquote",[s("p",[e._v("需开启"),s("code",[e._v("stream")]),e._v("模块")])]),e._v(" "),s("div",{staticClass:"language-nginxconfig extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("stream {\n\n    upstream group1 {\n        hash $remote_addr consistent;\n        server 78.141.198.151:4677;\n    }\n\n    server {\n        listen 4677;\n        listen 4677 udp;\n        proxy_pass group1;\n    }\n}\n\n")])])]),s("h3",{attrs:{id:"参数解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数解析"}},[e._v("#")]),e._v(" 参数解析")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("max_fails ："),s("br"),e._v("\n允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误")])]),e._v(" "),s("li",[s("p",[e._v("fail_timeout:"),s("br"),e._v("\nmax_fails次失败后，暂停的时间")])]),e._v(" "),s("li",[s("p",[e._v("config")])])]),e._v(" "),s("div",{staticClass:"language-smartyconfig extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('server {\n  listen 80;\n  listen 443 ssl http2;\n  ssl_certificate /usr/local/nginx/conf/ssl/cloud.penguinseven.club.crt;\n  ssl_certificate_key /usr/local/nginx/conf/ssl/cloud.penguinseven.club.key;\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n  ssl_prefer_server_ciphers on;\n  ssl_session_timeout 10m;\n  ssl_session_cache builtin:1000 shared:SSL:10m;\n  ssl_buffer_size 1400;\n  add_header Strict-Transport-Security max-age=15768000;\n  ssl_stapling on;\n  ssl_stapling_verify on;\n  server_name cloud.penguinseven.club;\n  access_log /data/wwwlogs/cloud.penguinseven.club_nginx.log combined;\n  index index.html index.htm index.php;\n  root /data/wwwroot/cloudreve;\n  if ($ssl_protocol = "") { return 301 https://$host$request_uri; }\n  \n  include /usr/local/nginx/conf/rewrite/thinkphp.conf;\n  #error_page 404 /404.html;\n  #error_page 502 /502.html;\n  \n  location ~ \\.php {\n    #fastcgi_pass remote_php_ip:9000;\n    fastcgi_pass unix:/dev/shm/php-cgi.sock;\n    fastcgi_index index.php;\n    include fastcgi_params;\n    set $real_script_name $fastcgi_script_name;\n    if ($fastcgi_script_name ~ "^(.+?\\.php)(/.+)$") {\n      set $real_script_name $1;\n      #set $path_info $2;\n    }\n    fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;\n    fastcgi_param SCRIPT_NAME $real_script_name;\n    #fastcgi_param PATH_INFO $path_info;\n  }\n\n  location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {\n    expires 30d;\n    access_log off;\n  }\n  location ~ .*\\.(js|css)?$ {\n    expires 7d;\n    access_log off;\n  }\n  location ~ /\\.ht {\n    deny all;\n  }\n}\n')])])]),s("h3",{attrs:{id:"跨域请求配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#跨域请求配置"}},[e._v("#")]),e._v(" 跨域请求配置")]),e._v(" "),s("div",{staticClass:"language-nginxconfig extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("server {\n    listen  80;\n    server_name  swarm.singbada.test;\n\n    access_log  /data/logs/keys_test/access_swarm_test.log  main;\n\n    root  /data/web/swarm/public;\n\n    index index.php index.html;\n\n    location ~ .*\\.(php|php5)?$ {\n\n        # 判断请求方式为“option”时\n        if ($request_method = 'OPTIONS') {\n            add_header 'Access-Control-Allow-Origin' '*';\n            add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Access-Control-Allow-Origin, Authorization';\n            add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS, PUT, PATCH, DELETE';\n            add_header 'Access-Control-Max-Age' 1728000;\n            add_header 'Content-Type' 'text/plain charset=UTF-8';\n            add_header 'Content-Length' 0;\n            return 204;\n         }\n            \n        # 生成环境中，将“*” 替换为实际域名更安全    \n        add_header 'Access-Control-Allow-Origin' '*';\n        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS, PUT, PATCH, DELETE';\n        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Access-Control-Allow-Origin, Authorization';\n\n        fastcgi_pass 127.0.0.1:9000;\n        fastcgi_index index.php;\n        include fastcgi.conf;\n    }\n\n    error_page   500 502 503 504  /50x.html;\n\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n\n    location ~ /.ht {\n        deny  all;\n    }\n\n    location / {\n        try_files $uri $uri/ /index.php?$query_string;\n    }\n}  \n")])])]),s("h3",{attrs:{id:"常见问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[e._v("#")]),e._v(" 常见问题")])])}),[],!1,null,null,null);s.default=r.exports}}]);