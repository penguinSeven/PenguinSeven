<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>吧食笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/PenguinSeven/logo.png">
    <meta name="description" content="PenguinSeven">
    
    <link rel="preload" href="/PenguinSeven/assets/css/0.styles.feb1df48.css" as="style"><link rel="preload" href="/PenguinSeven/assets/js/app.feb3916a.js" as="script"><link rel="preload" href="/PenguinSeven/assets/js/2.f28e70e0.js" as="script"><link rel="preload" href="/PenguinSeven/assets/js/1.bb87e0ea.js" as="script"><link rel="preload" href="/PenguinSeven/assets/js/72.a8402aeb.js" as="script"><link rel="prefetch" href="/PenguinSeven/assets/js/10.e38c7cc5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/100.b70b0c1d.js"><link rel="prefetch" href="/PenguinSeven/assets/js/101.46e03238.js"><link rel="prefetch" href="/PenguinSeven/assets/js/102.efb0e370.js"><link rel="prefetch" href="/PenguinSeven/assets/js/103.f5faa006.js"><link rel="prefetch" href="/PenguinSeven/assets/js/104.5564a1fa.js"><link rel="prefetch" href="/PenguinSeven/assets/js/105.39dab30f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/106.c0bb3b4a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/107.257c0c6e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/108.8fc0260e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/109.a137b455.js"><link rel="prefetch" href="/PenguinSeven/assets/js/11.d23c0f5a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/110.fc1e49b3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/111.4a8ae938.js"><link rel="prefetch" href="/PenguinSeven/assets/js/112.48914f2b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/12.3a7a7e61.js"><link rel="prefetch" href="/PenguinSeven/assets/js/13.f6d05845.js"><link rel="prefetch" href="/PenguinSeven/assets/js/14.619aee36.js"><link rel="prefetch" href="/PenguinSeven/assets/js/15.3b9d1f7c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/16.b49954cb.js"><link rel="prefetch" href="/PenguinSeven/assets/js/17.e528107c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/18.4f4038bf.js"><link rel="prefetch" href="/PenguinSeven/assets/js/19.bd01e132.js"><link rel="prefetch" href="/PenguinSeven/assets/js/20.e3c1893e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/21.3ba92fa5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/22.446578c9.js"><link rel="prefetch" href="/PenguinSeven/assets/js/23.1ec8450c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/24.65a37d34.js"><link rel="prefetch" href="/PenguinSeven/assets/js/25.4f168d23.js"><link rel="prefetch" href="/PenguinSeven/assets/js/26.5934d5a2.js"><link rel="prefetch" href="/PenguinSeven/assets/js/27.cb31c557.js"><link rel="prefetch" href="/PenguinSeven/assets/js/28.bd201709.js"><link rel="prefetch" href="/PenguinSeven/assets/js/29.f3679f2e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/3.0d8eae40.js"><link rel="prefetch" href="/PenguinSeven/assets/js/30.5d895107.js"><link rel="prefetch" href="/PenguinSeven/assets/js/31.2a21575b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/32.81ff732f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/33.ff7c2f5e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/34.9bdb8c46.js"><link rel="prefetch" href="/PenguinSeven/assets/js/35.da89b41e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/36.f8772b8e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/37.61105f93.js"><link rel="prefetch" href="/PenguinSeven/assets/js/38.f7790cf4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/39.54af282a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/4.4f963454.js"><link rel="prefetch" href="/PenguinSeven/assets/js/40.1a7a9b9a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/41.b02d0f12.js"><link rel="prefetch" href="/PenguinSeven/assets/js/42.b103deb5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/43.e0b77010.js"><link rel="prefetch" href="/PenguinSeven/assets/js/44.588ffc70.js"><link rel="prefetch" href="/PenguinSeven/assets/js/45.f5e03ed0.js"><link rel="prefetch" href="/PenguinSeven/assets/js/46.f0dea127.js"><link rel="prefetch" href="/PenguinSeven/assets/js/47.2fd249d7.js"><link rel="prefetch" href="/PenguinSeven/assets/js/48.687fabe4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/49.3fa54d08.js"><link rel="prefetch" href="/PenguinSeven/assets/js/5.5cd94255.js"><link rel="prefetch" href="/PenguinSeven/assets/js/50.055e08df.js"><link rel="prefetch" href="/PenguinSeven/assets/js/51.ce3e0044.js"><link rel="prefetch" href="/PenguinSeven/assets/js/52.9fd95bb4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/53.c26ffd47.js"><link rel="prefetch" href="/PenguinSeven/assets/js/54.0541a968.js"><link rel="prefetch" href="/PenguinSeven/assets/js/55.6209f14b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/56.d7565bf2.js"><link rel="prefetch" href="/PenguinSeven/assets/js/57.a153410b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/58.24db348e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/59.4215ec40.js"><link rel="prefetch" href="/PenguinSeven/assets/js/6.918d102d.js"><link rel="prefetch" href="/PenguinSeven/assets/js/60.8af7fe3a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/61.8176ca2c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/62.473842c3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/63.3dd08959.js"><link rel="prefetch" href="/PenguinSeven/assets/js/64.f8ff329c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/65.7c8e9d0f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/66.719e81e3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/67.aaaa6fb3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/68.941206b0.js"><link rel="prefetch" href="/PenguinSeven/assets/js/69.68b0053c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/7.47f27853.js"><link rel="prefetch" href="/PenguinSeven/assets/js/70.174fd7e6.js"><link rel="prefetch" href="/PenguinSeven/assets/js/71.d99ae443.js"><link rel="prefetch" href="/PenguinSeven/assets/js/73.f91e4cde.js"><link rel="prefetch" href="/PenguinSeven/assets/js/74.53345e83.js"><link rel="prefetch" href="/PenguinSeven/assets/js/75.5550825f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/76.7775f7d8.js"><link rel="prefetch" href="/PenguinSeven/assets/js/77.fc6220ec.js"><link rel="prefetch" href="/PenguinSeven/assets/js/78.b918de51.js"><link rel="prefetch" href="/PenguinSeven/assets/js/79.abf83adf.js"><link rel="prefetch" href="/PenguinSeven/assets/js/80.d8b3e41c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/81.ef42d0c5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/82.6b4daeeb.js"><link rel="prefetch" href="/PenguinSeven/assets/js/83.dd2cb066.js"><link rel="prefetch" href="/PenguinSeven/assets/js/84.16cd76e5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/85.361035e2.js"><link rel="prefetch" href="/PenguinSeven/assets/js/86.f15739f4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/87.c2e26100.js"><link rel="prefetch" href="/PenguinSeven/assets/js/88.3fd017d3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/89.da561da4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/90.af1641e9.js"><link rel="prefetch" href="/PenguinSeven/assets/js/91.a0270273.js"><link rel="prefetch" href="/PenguinSeven/assets/js/92.b1107c24.js"><link rel="prefetch" href="/PenguinSeven/assets/js/93.9f01b02f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/94.686f81a4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/95.f72d4f1c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/96.06d3c75c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/97.676935b9.js"><link rel="prefetch" href="/PenguinSeven/assets/js/98.8a6b338c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/99.f7e47ec4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/vendors~docsearch.70bf0358.js">
    <link rel="stylesheet" href="/PenguinSeven/assets/css/0.styles.feb1df48.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/PenguinSeven/" class="home-link router-link-active"><!----> <span class="site-name">吧食笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/PenguinSeven/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/PenguinSeven/php/" class="nav-link">
  PHP
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/PenguinSeven/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/PenguinSeven/php/" class="nav-link">
  PHP
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx配置location总结及rewrite规则写法"><a href="#nginx配置location总结及rewrite规则写法" class="header-anchor">#</a> nginx配置location总结及rewrite规则写法</h1> <h3 id="_1-location正则写法"><a href="#_1-location正则写法" class="header-anchor">#</a> 1. location正则写法</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">location</span>  = /</span> <span class="token punctuation">{</span>
  <span class="token comment"># 精确匹配 / ，主机名后面不能带任何字符串</span>
  [ configuration A ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span>  /</span> <span class="token punctuation">{</span>
  <span class="token comment"># 因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求</span>
  <span class="token comment"># 但是正则和最长字符串会优先匹配</span>
  [ configuration B ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> /documents/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索</span>
  <span class="token comment"># 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span>
  [ configuration C ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ~ /documents/Abc</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配任何以 /documents/Abc 开头的地址，匹配符合以后，还要继续往下搜索</span>
  <span class="token comment"># 只有后面的正则表达式没有匹配到时，这一条才会采用这一条</span>
  [ configuration CC ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ^~ /images/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条。</span>
  [ configuration D ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ~* \.(gif|jpg|jpeg)$</span> <span class="token punctuation">{</span>
  <span class="token comment"># 匹配所有以 gif,jpg或jpeg 结尾的请求</span>
  <span class="token comment"># 然而，所有请求 /images/ 下的图片会被 config D 处理，因为 ^~ 到达不了这一条正则</span>
  [ configuration E ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> /images/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 字符匹配到 /images/，继续往下，会发现 ^~ 存在</span>
  [ configuration F ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> /images/abc</span> <span class="token punctuation">{</span>
  <span class="token comment"># 最长字符匹配到 /images/abc，继续往下，会发现 ^~ 存在</span>
  <span class="token comment"># F与G的放置顺序是没有关系的</span>
  [ configuration G ]
<span class="token punctuation">}</span>
<span class="token directive"><span class="token keyword">location</span> ~ /images/abc/</span> <span class="token punctuation">{</span>
  <span class="token comment"># 只有去掉 config D 才有效：先最长匹配 config G 开头的地址，继续往下搜索，匹配到这一条正则，采用</span>
    [ configuration H ]
<span class="token punctuation">}</span>
location ~* /js/.*/\.js
</code></pre></div><ul><li><p>已=开头表示精确匹配 (如 A 中只匹配根目录结尾的请求，后面不能带任何字符串。)</p></li> <li><p>^~ 开头表示uri以某个常规字符串开头，不是正则匹配</p></li> <li><p>~ 开头表示区分大小写的正则匹配;</p></li> <li><p>~* 开头表示不区分大小写的正则匹配</p></li> <li><p>/ 通用匹配, 如果没有其它匹配,任何请求都会匹配到</p></li></ul> <p>顺序 no 优先级：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>    (location =) &gt; (location 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分起始路径) &gt; (/)
</code></pre></div><blockquote><p>上面的匹配结果,按照上面的location写法，以下的匹配示例成立：</p></blockquote> <ul><li>/ -&gt; config A<br>
精确完全匹配，即使/index.html也匹配不了</li> <li>/downloads/download.html -&gt; config B<br>
匹配B以后，往下没有任何匹配，采用B</li> <li>/images/1.gif -&gt; configuration D<br>
匹配到F，往下匹配到D，停止往下</li> <li>/images/abc/def -&gt; config D<br>
最长匹配到G，往下匹配D，停止往下
你可以看到 任何以/images/开头的都会匹配到D并停止，FG写在这里是没有任何意义的，H是永远轮不到的，这里只是为了说明匹配顺序</li> <li>/documents/document.html -&gt; config C<br>
匹配到C，往下没有任何匹配，采用C</li> <li>/documents/1.jpg -&gt; configuration E<br>
匹配到C，往下正则匹配到E</li> <li>/documents/Abc.jpg -&gt; config CC<br>
最长匹配到C，往下正则顺序匹配到CC，不会往下到E</li></ul> <h2 id="实际使用建议"><a href="#实际使用建议" class="header-anchor">#</a> 实际使用建议</h2> <div class="language-nginx extra-class"><pre class="language-nginx"><code>    <span class="token comment">#所以实际使用中，个人觉得至少有三个匹配规则定义，如下：</span>
    <span class="token comment">#直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。</span>
    <span class="token comment">#这里是直接转发给后端应用服务器了，也可以是一个静态首页</span>
    <span class="token comment"># 第一个必选规则</span>
    <span class="token directive"><span class="token keyword">location</span> = /</span> <span class="token punctuation">{</span>
        proxy_pass http://tomcat:8080/index
    <span class="token punctuation">}</span>
    <span class="token comment"># 第二个必选规则是处理静态文件请求，这是nginx作为http服务器的强项</span>
    <span class="token comment"># 有两种配置模式，目录匹配或后缀匹配,任选其一或搭配使用</span>
    <span class="token directive"><span class="token keyword">location</span> ^~ /static/</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /webroot/static/</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token directive"><span class="token keyword">location</span> ~* \.(gif|jpg|jpeg|png|css|js|ico)$</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /webroot/res/</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">#第三个规则就是通用规则，用来转发动态请求到后端应用服务器</span>
    <span class="token comment">#非静态文件请求就默认是动态请求，自己根据实际把握</span>
    <span class="token comment">#毕竟目前的一些框架的流行，带.php,.jsp后缀的情况很少了</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        proxy_pass http://tomcat:8080/
    <span class="token punctuation">}</span>
</code></pre></div><p><a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener noreferrer">http://nginx.org/en/docs/http/ngx_http_rewrite_module.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="http://tengine.taobao.org/book/chapter_02.html" target="_blank" rel="noopener noreferrer">http://tengine.taobao.org/book/chapter_02.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_2-rewrite规则"><a href="#_2-rewrite规则" class="header-anchor">#</a> 2. Rewrite规则</h3> <p>rewrite功能就是，使用nginx提供的全局变量或自己设置的变量，结合正则表达式和标志位实现url重写以及重定向。rewrite只能放在<font color="#00cc00">server{},location{},if{}</font>中，并且只能对域名后边的除去传递的参数外的字符串起作用，例如 http://seanlook.com/a/we/index.php?id=1&amp;u=str 只对/a/we/index.php重写。语法rewrite regex replacement [flag];</p> <p>如果相对域名或参数字符串起作用，可以使用全局变量匹配，也可以使用proxy_pass反向代理。</p> <p>表明看rewrite和location功能有点像，都能实现跳转，主要区别在于rewrite是在同一域名内更改获取资源的路径，而location是对一类路径做控制访问或反向代理，可以proxy_pass到其他机器。很多情况下rewrite也会写在location里，它们的执行顺序是：</p> <div class="language- extra-class"><pre class="language-text"><code>1. 执行server块的rewrite指令
2. 执行location匹配
3. 执行选定的location中的rewrite指令
</code></pre></div><p>如果其中某步URI被重写，则重新循环执行1-3，直到找到真实存在的文件；
循环超过<font color="red">10</font>次，则返回 <em>500 Internal Server Error</em> 错误。</p> <h3 id="_2-1-flag标志位"><a href="#_2-1-flag标志位" class="header-anchor">#</a> 2.1 flag标志位</h3> <ul><li>last : 相当于Apache的[L]标记，表示完成rewrite</li> <li>break : 停止执行当前虚拟主机的后续rewrite指令集</li> <li>redirect : 返回302临时重定向，地址栏会显示跳转后的地址</li> <li>permanent : 返回301永久重定向，地址栏会显示跳转后的地址</li></ul> <p>因为301和302不能简单的只返回状态码，还必须有重定向的URL，这就是return指令无法返回301,302的原因了。这里 last 和 break 区别有点难以理解：</p> <p>last一般写在server和if中，而break一般使用在location中
last不终止重写后的url匹配，即新的url会再从server走一遍匹配流程，而break终止重写后的匹配
break和last都能组织继续执行后面的rewrite指令</p> <h3 id="_2-2-if指令与全局变量"><a href="#_2-2-if指令与全局变量" class="header-anchor">#</a> 2.2 if指令与全局变量</h3> <blockquote><p>if判断指令</p></blockquote> <p>语法为if(condition){...}，对给定的条件condition进行判断。
如果为真，大括号内的rewrite指令将被执行，if条件(conditon)可以是如下任何内容：</p> <ul><li>当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会当做false</li> <li>直接比较变量和内容时，使用=或!=</li> <li>~正则表达式匹配，~*不区分大小写的匹配，!~区分大小写的不匹配</li></ul> <p>-f  和   !-f 用来判断是否存在文件<br>
-d  和   !-d 用来判断是否存在目录<br>
-e  和   !-e 用来判断是否存在文件或目录<br>
-x  和   !-x 用来判断文件是否可执行</p> <p>例如：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$http_user_agent</span> ~ MSIE)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^(.*)$ /msie/<span class="token variable">$1</span> break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> //如果UA包含&quot;MSIE&quot;，rewrite请求到/msid/目录下
<span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$http_cookie</span> ~* <span class="token string">&quot;id=([^;]+)(?:;|$)&quot;</span>)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$id</span> <span class="token variable">$1</span></span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> //如果cookie匹配正则，设置变量$id等于正则引用部分
<span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> = POST)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">return</span> <span class="token number">405</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> //如果提交方法为POST，则返回状态405（Method <span class="token directive"><span class="token keyword">not</span> allowed）。return不能返回301,302
if (<span class="token variable">$slow</span>)</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">limit_rate</span> <span class="token number">10k</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> //限速，$slow可以通过 <span class="token directive"><span class="token keyword">set</span> 指令设置
if (!-f <span class="token variable">$request_filename</span>)</span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">break</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span>  http://127.0.0.1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> //如果请求的文件名不存在，则反向代理到localhost 。这里的break也是停止rewrite检查
<span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$args</span> ~ post=140)</span><span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">rewrite</span> ^ http://example.com/ permanent</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> //如果query <span class="token directive"><span class="token keyword">string中包含&quot;post=140&quot;，永久重定向到example.com</span>
location ~* \.(gif|jpg|png|swf|flv)$</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">valid_referers</span> none blocked www.jefflei.com www.leizhenfang.com</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> //防盗链
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>全局变量</p></blockquote> <p>下面是可以用作if判断的全局变量</p> <ul><li>$args ： #这个变量等于请求行中的参数，同$query_string</li> <li>$content_length ： 请求头中的Content-length字段。</li> <li>$content_type ： 请求头中的Content-Type字段。</li> <li>$document_root ： 当前请求在root指令中指定的值。</li> <li>$host ： 请求主机头字段，否则为服务器名称。</li> <li>$http_user_agent ： 客户端agent信息</li> <li>$http_cookie ： 客户端cookie信息</li> <li>$limit_rate ： 这个变量可以限制连接速率。</li> <li>$request_method ： 客户端请求的动作，通常为GET或POST。</li> <li>$remote_addr ： 客户端的IP地址。</li> <li>$remote_port ： 客户端的端口。</li> <li>$remote_user ： 已经经过Auth Basic Module验证的用户名。</li> <li>$request_filename ： 当前请求的文件路径，由root或alias指令与URI请求生成。</li> <li>$scheme ： HTTP方法（如http，https）。</li> <li>$server_protocol ： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</li> <li>$server_addr ： 服务器地址，在完成一次系统调用后可以确定这个值。</li> <li>$server_name ： 服务器名称。</li> <li>$server_port ： 请求到达服务器的端口号。</li> <li>$request_uri ： 包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</li> <li>$uri ： 不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。</li> <li>$document_uri ： 与$uri相同。</li></ul> <blockquote><p>例：http://localhost:88/test1/test2/test.php</p></blockquote> <div class="language-nginx extra-class"><pre class="language-nginx"><code>$host：localhost
$server_port：88
$request_uri：http://localhost:88/test1/test2/test.php
$document_uri：/test1/test2/test.php
$document_root：/var/www/html
$request_filename：/var/www/html/test1/test2/test.php
</code></pre></div><h3 id="_2-3-常用正则"><a href="#_2-3-常用正则" class="header-anchor">#</a> 2.3 常用正则</h3> <div class="language-nginx extra-class"><pre class="language-nginx"><code>. ： 匹配除换行符以外的任意字符
? ： 重复0次或1次
+ ： 重复1次或更多次
* ： 重复0次或更多次
\d ：匹配数字
^ ： 匹配字符串的开始
$ ： 匹配字符串的介绍
<span class="token punctuation">{</span>n<span class="token punctuation">}</span> ： 重复n次
<span class="token punctuation">{</span>n,<span class="token punctuation">}</span> ： 重复n次或更多次
[c] ： 匹配单个字符c
[a-z] ： 匹配a-z小写字母的任意一个
</code></pre></div><p>小括号()之间匹配的内容，可以在后面通过$1来引用，<br>
$2表示的是前面第二个()里的内容。<br>
正则里面容易让人困惑的是\转义特殊字符。</p> <h3 id="_2-4-rewrite实例"><a href="#_2-4-rewrite实例" class="header-anchor">#</a> 2.4 rewrite实例</h3> <p>例1：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span>
    <span class="token comment"># 定义image日志格式</span>
    <span class="token directive"><span class="token keyword">log_format</span> imagelog <span class="token string">'[<span class="token variable">$time_local]</span> '</span> <span class="token variable">$image_file</span> <span class="token string">' '</span> <span class="token variable">$image_type</span> <span class="token string">' '</span> <span class="token variable">$body_bytes_sent</span> <span class="token string">' '</span> <span class="token variable">$status</span></span><span class="token punctuation">;</span>
    <span class="token comment"># 开启重写日志</span>
    <span class="token directive"><span class="token keyword">rewrite_log</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">root</span> /home/www</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
                <span class="token comment"># 重写规则信息</span>
                <span class="token directive"><span class="token keyword">error_log</span> logs/rewrite.log notice</span><span class="token punctuation">;</span>
                <span class="token comment"># 注意这里要用‘’单引号引起来，避免{}</span>
                <span class="token directive"><span class="token keyword">rewrite</span> <span class="token string">'^/images/([a-z]{2})/([a-z0-9]{5})/(.*)\.(png|jpg|gif)$'</span> /data?file=<span class="token variable">$3</span>.<span class="token variable">$4</span></span><span class="token punctuation">;</span>
                <span class="token comment"># 注意不能在上面这条规则后面加上“last”参数，否则下面的set指令不会执行</span>
                <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$image_file</span> <span class="token variable">$3</span></span><span class="token punctuation">;</span>
                <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$image_type</span> <span class="token variable">$4</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token directive"><span class="token keyword">location</span> /data</span> <span class="token punctuation">{</span>
                <span class="token comment"># 指定针对图片的日志格式，来分析图片类型和大小</span>
                <span class="token directive"><span class="token keyword">access_log</span> logs/images.log mian</span><span class="token punctuation">;</span>
                <span class="token directive"><span class="token keyword">root</span> /data/images</span><span class="token punctuation">;</span>
                <span class="token comment"># 应用前面定义的变量。判断首先文件在不在，不在再判断目录在不在，如果还不在就跳转到最后一个url里</span>
                <span class="token directive"><span class="token keyword">try_files</span> /<span class="token variable">$arg_file</span> /image404.html</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token directive"><span class="token keyword">location</span> = /image404.html</span> <span class="token punctuation">{</span>
                <span class="token comment"># 图片不存在返回特定的信息</span>
                <span class="token directive"><span class="token keyword">return</span> <span class="token number">404</span> <span class="token string">&quot;image not found<span class="token escape entity">\n</span>&quot;</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对形如/images/ef/uh7b3/test.png的请求，重写到/data?file=test.png，于是匹配到location /data，先看/data/images/test.png文件存不存在，如果存在则正常响应，如果不存在则重写tryfiles到新的image404 location，直接返回404状态码。</p> <blockquote><p>例2：</p></blockquote> <div class="language-nginx extra-class"><pre class="language-nginx"><code>	
<span class="token directive"><span class="token keyword">rewrite</span> ^/images/(.*)_(\d+)x(\d+)\.(png|jpg|gif)$ /resizer/<span class="token variable">$1</span>.<span class="token variable">$4</span>?width=<span class="token variable">$2</span>&amp;height=<span class="token variable">$3</span>? last</span><span class="token punctuation">;</span>
</code></pre></div><p>对形如/images/bla_500x400.jpg的文件请求，重写到/resizer/bla.jpg?width=500&amp;height=400地址，并会继续尝试匹配location。</p> <blockquote><p>链接：</p></blockquote> <p><a href="http://www.nginx.cn/216.html" target="_blank" rel="noopener noreferrer">http://www.nginx.cn/216.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="http://www.ttlsa.com/nginx/nginx-rewriting-rules-guide/" target="_blank" rel="noopener noreferrer">http://www.ttlsa.com/nginx/nginx-rewriting-rules-guide/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="http://fantefei.blog.51cto.com/2229719/919431" target="_blank" rel="noopener noreferrer">http://fantefei.blog.51cto.com/2229719/919431<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">5/2/2018, 10:29:20 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/PenguinSeven/assets/js/app.feb3916a.js" defer></script><script src="/PenguinSeven/assets/js/2.f28e70e0.js" defer></script><script src="/PenguinSeven/assets/js/1.bb87e0ea.js" defer></script><script src="/PenguinSeven/assets/js/72.a8402aeb.js" defer></script>
  </body>
</html>
