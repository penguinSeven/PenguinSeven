<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx | 吧食笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/PenguinSeven/logo.png">
    <meta name="description" content="PenguinSeven">
    
    <link rel="preload" href="/PenguinSeven/assets/css/0.styles.feb1df48.css" as="style"><link rel="preload" href="/PenguinSeven/assets/js/app.feb3916a.js" as="script"><link rel="preload" href="/PenguinSeven/assets/js/2.f28e70e0.js" as="script"><link rel="preload" href="/PenguinSeven/assets/js/1.bb87e0ea.js" as="script"><link rel="preload" href="/PenguinSeven/assets/js/69.68b0053c.js" as="script"><link rel="prefetch" href="/PenguinSeven/assets/js/10.e38c7cc5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/100.b70b0c1d.js"><link rel="prefetch" href="/PenguinSeven/assets/js/101.46e03238.js"><link rel="prefetch" href="/PenguinSeven/assets/js/102.efb0e370.js"><link rel="prefetch" href="/PenguinSeven/assets/js/103.f5faa006.js"><link rel="prefetch" href="/PenguinSeven/assets/js/104.5564a1fa.js"><link rel="prefetch" href="/PenguinSeven/assets/js/105.39dab30f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/106.c0bb3b4a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/107.257c0c6e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/108.8fc0260e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/109.a137b455.js"><link rel="prefetch" href="/PenguinSeven/assets/js/11.d23c0f5a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/110.fc1e49b3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/111.4a8ae938.js"><link rel="prefetch" href="/PenguinSeven/assets/js/112.48914f2b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/12.3a7a7e61.js"><link rel="prefetch" href="/PenguinSeven/assets/js/13.f6d05845.js"><link rel="prefetch" href="/PenguinSeven/assets/js/14.619aee36.js"><link rel="prefetch" href="/PenguinSeven/assets/js/15.3b9d1f7c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/16.b49954cb.js"><link rel="prefetch" href="/PenguinSeven/assets/js/17.e528107c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/18.4f4038bf.js"><link rel="prefetch" href="/PenguinSeven/assets/js/19.bd01e132.js"><link rel="prefetch" href="/PenguinSeven/assets/js/20.e3c1893e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/21.3ba92fa5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/22.446578c9.js"><link rel="prefetch" href="/PenguinSeven/assets/js/23.1ec8450c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/24.65a37d34.js"><link rel="prefetch" href="/PenguinSeven/assets/js/25.4f168d23.js"><link rel="prefetch" href="/PenguinSeven/assets/js/26.5934d5a2.js"><link rel="prefetch" href="/PenguinSeven/assets/js/27.cb31c557.js"><link rel="prefetch" href="/PenguinSeven/assets/js/28.bd201709.js"><link rel="prefetch" href="/PenguinSeven/assets/js/29.f3679f2e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/3.0d8eae40.js"><link rel="prefetch" href="/PenguinSeven/assets/js/30.5d895107.js"><link rel="prefetch" href="/PenguinSeven/assets/js/31.2a21575b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/32.81ff732f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/33.ff7c2f5e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/34.9bdb8c46.js"><link rel="prefetch" href="/PenguinSeven/assets/js/35.da89b41e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/36.f8772b8e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/37.61105f93.js"><link rel="prefetch" href="/PenguinSeven/assets/js/38.f7790cf4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/39.54af282a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/4.4f963454.js"><link rel="prefetch" href="/PenguinSeven/assets/js/40.1a7a9b9a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/41.b02d0f12.js"><link rel="prefetch" href="/PenguinSeven/assets/js/42.b103deb5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/43.e0b77010.js"><link rel="prefetch" href="/PenguinSeven/assets/js/44.588ffc70.js"><link rel="prefetch" href="/PenguinSeven/assets/js/45.f5e03ed0.js"><link rel="prefetch" href="/PenguinSeven/assets/js/46.f0dea127.js"><link rel="prefetch" href="/PenguinSeven/assets/js/47.2fd249d7.js"><link rel="prefetch" href="/PenguinSeven/assets/js/48.687fabe4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/49.3fa54d08.js"><link rel="prefetch" href="/PenguinSeven/assets/js/5.5cd94255.js"><link rel="prefetch" href="/PenguinSeven/assets/js/50.055e08df.js"><link rel="prefetch" href="/PenguinSeven/assets/js/51.ce3e0044.js"><link rel="prefetch" href="/PenguinSeven/assets/js/52.9fd95bb4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/53.c26ffd47.js"><link rel="prefetch" href="/PenguinSeven/assets/js/54.0541a968.js"><link rel="prefetch" href="/PenguinSeven/assets/js/55.6209f14b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/56.d7565bf2.js"><link rel="prefetch" href="/PenguinSeven/assets/js/57.a153410b.js"><link rel="prefetch" href="/PenguinSeven/assets/js/58.24db348e.js"><link rel="prefetch" href="/PenguinSeven/assets/js/59.4215ec40.js"><link rel="prefetch" href="/PenguinSeven/assets/js/6.918d102d.js"><link rel="prefetch" href="/PenguinSeven/assets/js/60.8af7fe3a.js"><link rel="prefetch" href="/PenguinSeven/assets/js/61.8176ca2c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/62.473842c3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/63.3dd08959.js"><link rel="prefetch" href="/PenguinSeven/assets/js/64.f8ff329c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/65.7c8e9d0f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/66.719e81e3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/67.aaaa6fb3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/68.941206b0.js"><link rel="prefetch" href="/PenguinSeven/assets/js/7.47f27853.js"><link rel="prefetch" href="/PenguinSeven/assets/js/70.174fd7e6.js"><link rel="prefetch" href="/PenguinSeven/assets/js/71.d99ae443.js"><link rel="prefetch" href="/PenguinSeven/assets/js/72.a8402aeb.js"><link rel="prefetch" href="/PenguinSeven/assets/js/73.f91e4cde.js"><link rel="prefetch" href="/PenguinSeven/assets/js/74.53345e83.js"><link rel="prefetch" href="/PenguinSeven/assets/js/75.5550825f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/76.7775f7d8.js"><link rel="prefetch" href="/PenguinSeven/assets/js/77.fc6220ec.js"><link rel="prefetch" href="/PenguinSeven/assets/js/78.b918de51.js"><link rel="prefetch" href="/PenguinSeven/assets/js/79.abf83adf.js"><link rel="prefetch" href="/PenguinSeven/assets/js/80.d8b3e41c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/81.ef42d0c5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/82.6b4daeeb.js"><link rel="prefetch" href="/PenguinSeven/assets/js/83.dd2cb066.js"><link rel="prefetch" href="/PenguinSeven/assets/js/84.16cd76e5.js"><link rel="prefetch" href="/PenguinSeven/assets/js/85.361035e2.js"><link rel="prefetch" href="/PenguinSeven/assets/js/86.f15739f4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/87.c2e26100.js"><link rel="prefetch" href="/PenguinSeven/assets/js/88.3fd017d3.js"><link rel="prefetch" href="/PenguinSeven/assets/js/89.da561da4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/90.af1641e9.js"><link rel="prefetch" href="/PenguinSeven/assets/js/91.a0270273.js"><link rel="prefetch" href="/PenguinSeven/assets/js/92.b1107c24.js"><link rel="prefetch" href="/PenguinSeven/assets/js/93.9f01b02f.js"><link rel="prefetch" href="/PenguinSeven/assets/js/94.686f81a4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/95.f72d4f1c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/96.06d3c75c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/97.676935b9.js"><link rel="prefetch" href="/PenguinSeven/assets/js/98.8a6b338c.js"><link rel="prefetch" href="/PenguinSeven/assets/js/99.f7e47ec4.js"><link rel="prefetch" href="/PenguinSeven/assets/js/vendors~docsearch.70bf0358.js">
    <link rel="stylesheet" href="/PenguinSeven/assets/css/0.styles.feb1df48.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/PenguinSeven/" class="home-link router-link-active"><!----> <span class="site-name">吧食笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/PenguinSeven/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/PenguinSeven/php/" class="nav-link">
  PHP
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/PenguinSeven/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/PenguinSeven/php/" class="nav-link">
  PHP
</a></div><div class="nav-item"><a href="https://google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h1> <h2 id="负载均衡-权重-ip-hash"><a href="#负载均衡-权重-ip-hash" class="header-anchor">#</a> 负载均衡，权重，ip_hash</h2> <h3 id="新建一个proxy-conf文件"><a href="#新建一个proxy-conf文件" class="header-anchor">#</a> 新建一个proxy.conf文件</h3> <div class="language- extra-class"><pre><code>proxy_redirect off;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
client_body_buffer_size 90;
proxy_connect_timeout 90;
proxy_read_timeout 90;
proxy_buffer_size 4k;
proxy_buffers 4 32k;
proxy_busy_buffers_size 64k;
proxy_temp_file_write_size 64k;
</code></pre></div><h3 id="两种负载均衡方式"><a href="#两种负载均衡方式" class="header-anchor">#</a> 两种负载均衡方式</h3> <blockquote><p>这个配置文件,我们可以写到nginx.conf里面(如果只有一个web集群)，<br>
如果有多个web集群,最好写到vhosts里面,以虚拟主机的方式,这里我写到nginx.conf里面</p></blockquote> <ul><li>轮询加权<br>
(也可以不加权,就是1:1负载)</li></ul> <div class="language-config extra-class"><pre class="language-text"><code>    upstream lb {
            server 192.168.196.130 weight=1 fail_timeout=20s;
            server 192.168.196.132 weight=2 fail_timeout=20s;
    }
    
    server {
            listen 80;
            server_name safexjt.com www.safexjt.com;
            index index.html index.htm index.php;
            location / {
            
                proxy_pass http://lb;
                proxy_next_upstream http_500 http_502 http_503 error timeout invalid_header;
                include proxy.conf;
            }
    }
</code></pre></div><ul><li>ip_hash<br>
(同一ip会被分配给固定的后端服务器,解决session问题)</li></ul> <div class="language-config extra-class"><pre class="language-text"><code>    upstream lb {
    
        server 192.168.196.130 fail_timeout=20s;
        server 192.168.196.132 fail_timeout=20s;
        ip_hash;
    }
    
    server {
        listen 80;
        server_name safexjt.com www.safexjt.com;
        index index.html index.htm index.php;
        location / {
            proxy_pass http://lb;
            proxy_next_upstream http_500 http_502 http_503 error timeout invalid_header;
            include proxy.conf;
        }
    }
</code></pre></div><h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <h4 id="轮询-默认"><a href="#轮询-默认" class="header-anchor">#</a> 轮询（默认）</h4> <p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p> <div class="language- extra-class"><pre><code>upstream backserver {
    server 192.168.0.14;
    server 192.168.0.15;
}
</code></pre></div><h4 id="指定权重"><a href="#指定权重" class="header-anchor">#</a> 指定权重</h4> <p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</p> <div class="language- extra-class"><pre><code>upstream backserver {
    server 192.168.0.14 weight=10;
    server 192.168.0.15 weight=10;
}
</code></pre></div><h4 id="ip绑定-ip-hash"><a href="#ip绑定-ip-hash" class="header-anchor">#</a> IP绑定 ip_hash</h4> <p>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</p> <div class="language- extra-class"><pre><code>upstream backserver {
    ip_hash;
    server 192.168.0.14:88;
    server 192.168.0.15:80;
}
</code></pre></div><h4 id="fair-第三方"><a href="#fair-第三方" class="header-anchor">#</a> fair（第三方）</h4> <p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p> <div class="language- extra-class"><pre><code>upstream backserver {
    server server1;
    server server2;
    fair;
}
</code></pre></div><h4 id="url-hash-第三方"><a href="#url-hash-第三方" class="header-anchor">#</a> url_hash（第三方）</h4> <p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</p> <div class="language- extra-class"><pre><code>upstream backserver {
    server squid1:3128;
    server squid2:3128;
    hash $request_uri;
    hash_method crc32;
}
</code></pre></div><p>在需要使用负载均衡的server中增加</p> <div class="language- extra-class"><pre><code>proxy_pass http://backserver/;
upstream backserver{
    ip_hash;
    server 127.0.0.1:9090 down; (down 表示单前的server暂时不参与负载)
    server 127.0.0.1:8080 weight=2; (weight 默认为1.weight越大，负载的权重就越大)
    server 127.0.0.1:6060;
    server 127.0.0.1:7070 backup; (其它所有的非backup机器down或者忙的时候，请求backup机器)
}
</code></pre></div><h4 id="tcp转发"><a href="#tcp转发" class="header-anchor">#</a> TCP转发</h4> <blockquote><p>需开启<code>stream</code>模块</p></blockquote> <div class="language-nginxconfig extra-class"><pre class="language-text"><code>stream {

    upstream group1 {
        hash $remote_addr consistent;
        server 78.141.198.151:4677;
    }

    server {
        listen 4677;
        listen 4677 udp;
        proxy_pass group1;
    }
}

</code></pre></div><h3 id="参数解析"><a href="#参数解析" class="header-anchor">#</a> 参数解析</h3> <ul><li><p>max_fails ：<br>
允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误</p></li> <li><p>fail_timeout:<br>
max_fails次失败后，暂停的时间</p></li> <li><p>config</p></li></ul> <div class="language-smartyconfig extra-class"><pre class="language-text"><code>server {
  listen 80;
  listen 443 ssl http2;
  ssl_certificate /usr/local/nginx/conf/ssl/cloud.penguinseven.club.crt;
  ssl_certificate_key /usr/local/nginx/conf/ssl/cloud.penguinseven.club.key;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
  ssl_prefer_server_ciphers on;
  ssl_session_timeout 10m;
  ssl_session_cache builtin:1000 shared:SSL:10m;
  ssl_buffer_size 1400;
  add_header Strict-Transport-Security max-age=15768000;
  ssl_stapling on;
  ssl_stapling_verify on;
  server_name cloud.penguinseven.club;
  access_log /data/wwwlogs/cloud.penguinseven.club_nginx.log combined;
  index index.html index.htm index.php;
  root /data/wwwroot/cloudreve;
  if ($ssl_protocol = &quot;&quot;) { return 301 https://$host$request_uri; }
  
  include /usr/local/nginx/conf/rewrite/thinkphp.conf;
  #error_page 404 /404.html;
  #error_page 502 /502.html;
  
  location ~ \.php {
    #fastcgi_pass remote_php_ip:9000;
    fastcgi_pass unix:/dev/shm/php-cgi.sock;
    fastcgi_index index.php;
    include fastcgi_params;
    set $real_script_name $fastcgi_script_name;
    if ($fastcgi_script_name ~ &quot;^(.+?\.php)(/.+)$&quot;) {
      set $real_script_name $1;
      #set $path_info $2;
    }
    fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;
    fastcgi_param SCRIPT_NAME $real_script_name;
    #fastcgi_param PATH_INFO $path_info;
  }

  location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|mp4|ico)$ {
    expires 30d;
    access_log off;
  }
  location ~ .*\.(js|css)?$ {
    expires 7d;
    access_log off;
  }
  location ~ /\.ht {
    deny all;
  }
}
</code></pre></div><h3 id="跨域请求配置"><a href="#跨域请求配置" class="header-anchor">#</a> 跨域请求配置</h3> <div class="language-nginxconfig extra-class"><pre class="language-text"><code>server {
    listen  80;
    server_name  swarm.singbada.test;

    access_log  /data/logs/keys_test/access_swarm_test.log  main;

    root  /data/web/swarm/public;

    index index.php index.html;

    location ~ .*\.(php|php5)?$ {

        # 判断请求方式为“option”时
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Access-Control-Allow-Origin, Authorization';
            add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS, PUT, PATCH, DELETE';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
         }
            
        # 生成环境中，将“*” 替换为实际域名更安全    
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'POST, GET, OPTIONS, PUT, PATCH, DELETE';
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Access-Control-Allow-Origin, Authorization';

        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        include fastcgi.conf;
    }

    error_page   500 502 503 504  /50x.html;

    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    location ~ /.ht {
        deny  all;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}  
</code></pre></div><h3 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h3></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">8/21/2019, 8:23:49 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/PenguinSeven/assets/js/app.feb3916a.js" defer></script><script src="/PenguinSeven/assets/js/2.f28e70e0.js" defer></script><script src="/PenguinSeven/assets/js/1.bb87e0ea.js" defer></script><script src="/PenguinSeven/assets/js/69.68b0053c.js" defer></script>
  </body>
</html>
